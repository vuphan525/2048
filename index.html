<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 Deluxe ‚Äî One File</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --text: #e6e9ef;
      --muted: #a0a7b4;
      --accent: #7c5cff;
      --good: #26d07c;
      --bad: #ff6b6b;
      --cell: #1e2230;
      --cell-empty: #151924;
      --shadow: 0 10px 30px rgba(0,0,0,.3);
    }
    .light {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --text: #1a1d28;
      --muted: #5c6370;
      --accent: #6a5cff;
      --good: #17b26a;
      --bad: #e5484d;
      --cell: #f0f3f8;
      --cell-empty: #e7ebf3;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; 
      background: radial-gradient(1200px 800px at 70% -10%, rgba(124,92,255,.15), transparent 60%) , var(--bg);
      color: var(--text);
      display: grid; place-items: center;
    }

    .wrap { width: min(820px, 94vw); }

    header {
      display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 24px 0 12px;
    }
    .title { display: flex; align-items: baseline; gap: 12px; }
    .title h1 { margin: 0; font-size: clamp(28px, 4vw, 40px); letter-spacing: .5px; }
    .title .badge { background: linear-gradient(135deg, var(--accent), #59a0ff); color: white; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; box-shadow: var(--shadow); }

    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button, select {
      border: 0; outline: 0; cursor: pointer; padding: 10px 14px; border-radius: 12px; background: var(--panel); color: var(--text); box-shadow: var(--shadow); font-weight: 600; transition: transform .08s ease, filter .2s ease; 
    }
    button:hover, select:hover { filter: brightness(1.05); }
    button:active { transform: translateY(2px); }
    .btn-accent { background: linear-gradient(135deg, var(--accent), #59a0ff); color: white; }
    .btn-good { background: linear-gradient(135deg, var(--good), #63e6b6); color: #0b3b2a; }

    .stats { display: flex; gap: 12px; }
    .pill { background: var(--panel); padding: 8px 12px; border-radius: 12px; display: flex; gap: 8px; align-items: center; box-shadow: var(--shadow); }
    .pill b { font-variant-numeric: tabular-nums; }

    .board-wrap { position: relative; background: var(--panel); border-radius: 18px; padding: 16px; box-shadow: var(--shadow); }

    .grid {
      --size: 4; /* default, will be updated via JS */
      display: grid; gap: 12px; 
      grid-template-columns: repeat(var(--size), 1fr);
      grid-template-rows: repeat(var(--size), 1fr);
      width: min(560px, 94vw); height: min(560px, 94vw);
      margin: 10px auto 0;
      position: relative;
    }

    .cell { 
      display: grid; place-items: center; 
      background: var(--cell-empty); color: var(--text); 
      border-radius: 12px; font-weight: 800; font-size: clamp(18px, 5vw, 38px);
      position: relative; overflow: hidden; 
      transition: background .25s ease;
    }

    .tile { 
      position: absolute; inset: 0; display: grid; place-items: center;
      border-radius: 12px; font-weight: 800; font-size: clamp(18px, 5vw, 38px);
      transform-origin: center; 
      transition: transform .12s ease;
    }
    .tile.pop { animation: pop .18s ease; }
    .tile.merged { animation: pop .22s cubic-bezier(.2, 1.5, .3, 1); }
    @keyframes pop { from { transform: scale(.6); } to { transform: scale(1); } }

    .overlay { 
      position: absolute; inset: 0; display: none; place-items: center; 
      background: rgba(0,0,0,.5); border-radius: 18px; 
      backdrop-filter: blur(2px);
    }
    .overlay.show { display: grid; }
    .overlay .panel { background: var(--panel); padding: 18px; border-radius: 14px; text-align: center; box-shadow: var(--shadow); }
    .overlay h2 { margin: 0 0 10px; }

    /* Tile color palette */
    .v2    { background: linear-gradient(135deg, #eee4da, #eaddcf); color: #5c4a3d; }
    .v4    { background: linear-gradient(135deg, #ede0c8, #ead8b4); color: #5c4a3d; }
    .v8    { background: linear-gradient(135deg, #f2b179, #f59563); color: #fff; }
    .v16   { background: linear-gradient(135deg, #f59563, #f57c5f); color: #fff; }
    .v32   { background: linear-gradient(135deg, #f67c5f, #f65e3b); color: #fff; }
    .v64   { background: linear-gradient(135deg, #f65e3b, #ed3a3a); color: #fff; }
    .v128  { background: linear-gradient(135deg, #edcf72, #edc850); color: #fff; }
    .v256  { background: linear-gradient(135deg, #edc850, #edc53f); color: #fff; }
    .v512  { background: linear-gradient(135deg, #edc53f, #edc22e); color: #fff; }
    .v1024 { background: linear-gradient(135deg, #6ee7b7, #34d399); color: #0b3b2a; }
    .v2048 { background: linear-gradient(135deg, #7c5cff, #59a0ff); color: #fff; }
    .v4096, .v8192 { background: linear-gradient(135deg, #d946ef, #a855f7); color: #fff; }

    footer { margin: 16px 0 28px; color: var(--muted); text-align: center; font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>2048 Deluxe</h1>
        <span class="badge">HTML ‚Ä¢ CSS ‚Ä¢ JS</span>
      </div>
      <div class="controls">
        <div class="stats">
          <div class="pill">Score: <b id="score">0</b></div>
          <div class="pill">Best: <b id="best">0</b></div>
        </div>
        <select id="sizeSelect" title="K√≠ch th∆∞·ªõc b√†n" aria-label="K√≠ch th∆∞·ªõc">
          <option value="4" selected>4√ó4</option>
          <option value="5">5√ó5</option>
        </select>
        <button id="newBtn" class="btn-good">New Game</button>
        <button id="undoBtn">Undo</button>
        <button id="themeBtn" class="btn-accent">Light / Dark</button>
      </div>
    </header>

    <div class="board-wrap">
      <div id="grid" class="grid" aria-label="B√†n ch∆°i"></div>
      <div id="overlay" class="overlay" role="dialog" aria-modal="true">
        <div class="panel">
          <h2 id="overlayTitle">Game Over</h2>
          <p id="overlayMsg">H·∫øt n∆∞·ªõc ƒëi r·ªìi üòµ</p>
          <button id="againBtn" class="btn-good">Ch∆°i l·∫°i</button>
        </div>
      </div>
    </div>

    <footer>
      ƒêi·ªÅu khi·ªÉn: ph√≠m m≈©i t√™n / WASD ho·∫∑c vu·ªët tr√™n ƒëi·ªán tho·∫°i. C√≥ <b>Undo</b>, l∆∞u <b>Best</b>, v√† Dark/Light.
    </footer>
  </div>

  <script>
    // ===== Utility =====
    const $ = (sel) => document.querySelector(sel);
    const rand = (n) => Math.floor(Math.random() * n);

    // ===== Game State =====
    let SIZE = 4;
    let board = [];// 2D array
    let score = 0;
    let best = Number(localStorage.getItem('best_2048')||0);
    let history = []; // stack of {board, score}

    const gridEl = $('#grid');
    const scoreEl = $('#score');
    const bestEl = $('#best');
    const overlay = $('#overlay');
    const overlayTitle = $('#overlayTitle');
    const overlayMsg = $('#overlayMsg');

    bestEl.textContent = best;

    function cloneBoard(b){ return b.map(row => row.slice()); }

    function emptyBoard(){ return Array.from({length: SIZE}, ()=> Array(SIZE).fill(0)); }

    function getEmptyCells(b){
      const cells = [];
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(b[r][c]===0) cells.push([r,c]);
      return cells;
    }

    function addRandomTile(b){
      const empties = getEmptyCells(b);
      if(!empties.length) return false;
      const [r,c] = empties[rand(empties.length)];
      b[r][c] = Math.random() < 0.9 ? 2 : 4;
      return [r,c];
    }

    function canMove(b){
      if(getEmptyCells(b).length) return true;
      for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
          const v=b[r][c];
          if((r+1<SIZE && b[r+1][c]===v) || (c+1<SIZE && b[r][c+1]===v)) return true;
        }
      }
      return false;
    }

    function compressAndMerge(line){
      const arr = line.filter(v=>v!==0);
      let mergedScore = 0;
      let mergedFlags = Array(arr.length).fill(false);
      for(let i=0;i<arr.length-1;i++){
        if(arr[i]!==0 && arr[i]===arr[i+1] && !mergedFlags[i] && !mergedFlags[i+1]){
          arr[i] *= 2; mergedScore += arr[i]; arr.splice(i+1,1); mergedFlags[i]=true;
        }
      }
      while(arr.length<SIZE) arr.push(0);
      return {arr, mergedScore};
    }

    function rotate(b){ // clockwise
      const nb = emptyBoard();
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) nb[c][SIZE-1-r]=b[r][c];
      return nb;
    }

    function moveLeft(b){
      let moved=false, gained=0, mergedMap = new Set();
      const nb = b.map((row,ri)=>{
        const before = row.join(',');
        const {arr, mergedScore} = compressAndMerge(row);
        if(arr.join(',')!==before) moved=true;
        gained += mergedScore;
        // Mark merged tiles for animation: find spots where value came from a merge (heuristic)
        // We mark all non-zero tiles that are results of a power of two > original max in row
        return arr;
      });
      return {board: nb, moved, gained, mergedMap};
    }

    function move(dir){
      // dir: 'left','right','up','down'
      let b = cloneBoard(board);
      let rotations = 0;
      if(dir==='up') rotations=3; // rotate 3 times (right->down->left)
      if(dir==='right') rotations=2;
      if(dir==='down') rotations=1;
      for(let i=0;i<rotations;i++) b = rotate(b);
      const {board: nb, moved, gained} = moveLeft(b);
      let rb = nb;
      for(let i=0;i<(4-rotations)%4;i++) rb = rotate(rb);
      return {board: rb, moved, gained};
    }

    function saveHistory(){
      history.push({board: cloneBoard(board), score});
      if(history.length>50) history.shift();
    }

    function undo(){
      const last = history.pop();
      if(!last) return;
      board = last.board; score = last.score; render(); hideOverlay();
    }

    function reset(){
      SIZE = Number($('#sizeSelect').value);
      board = emptyBoard(); score = 0; history = [];
      addRandomTile(board); addRandomTile(board);
      render(true);
      hideOverlay();
      persistState();
    }

    function persistState(){
      localStorage.setItem('best_2048', String(best));
      localStorage.setItem('state_2048', JSON.stringify({board, score, size: SIZE}));
    }

    function restoreState(){
      try{
        const raw = localStorage.getItem('state_2048');
        if(!raw) return false;
        const s = JSON.parse(raw);
        if(!s || !s.board || !s.size) return false;
        $('#sizeSelect').value = s.size;
        SIZE = s.size; board = s.board; score = s.score || 0; render(true);
        return true;
      }catch(e){ return false; }
    }

    function showOverlay(title, msg){
      overlayTitle.textContent = title; overlayMsg.textContent = msg; overlay.classList.add('show');
    }
    function hideOverlay(){ overlay.classList.remove('show'); }

    function render(initial=false, highlights={}){
      gridEl.style.setProperty('--size', SIZE);
      gridEl.innerHTML = '';
      // Build cells
      for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
          const wrap = document.createElement('div');
          wrap.className = 'cell';
          const v = board[r][c];
          if(v){
            const tile = document.createElement('div');
            tile.className = 'tile v'+v + (initial? ' pop' : '');
            tile.textContent = v;
            if(highlights[`${r},${c}`]==='new') tile.classList.add('pop');
            if(highlights[`${r},${c}`]==='merged') tile.classList.add('merged');
            wrap.appendChild(tile);
          }
          gridEl.appendChild(wrap);
        }
      }
      scoreEl.textContent = score;
      if(score>best){ best=score; bestEl.textContent = best; }
      persistState();
    }

    function step(dir){
      const {board: nb, moved, gained} = move(dir);
      if(!moved) return;
      saveHistory();
      board = nb; score += gained;
      const pos = addRandomTile(board);
      const hi={}; if(pos) hi[`${pos[0]},${pos[1]}`] = 'new';
      render(false, hi);
      if(!canMove(board)) showOverlay('Game Over', 'H·∫øt n∆∞·ªõc ƒëi r·ªìi üòµ\nScore: '+score);
      else if(board.some(row=>row.some(v=>v===2048))) showOverlay('You Win!', 'B·∫°n gh√©p ƒë∆∞·ª£c 2048! üéâ');
    }

    // ===== Inputs =====
    document.addEventListener('keydown', (e)=>{
      const k=e.key.toLowerCase();
      if(['arrowleft','a'].includes(k)) step('left');
      else if(['arrowright','d'].includes(k)) step('right');
      else if(['arrowup','w'].includes(k)) step('up');
      else if(['arrowdown','s'].includes(k)) step('down');
    });

    // Touch / swipe
    let touchStart=null;
    gridEl.addEventListener('touchstart', e=>{ if(e.touches.length===1) touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY}; },{passive:true});
    gridEl.addEventListener('touchmove', e=>{ e.preventDefault(); },{passive:false});
    gridEl.addEventListener('touchend', e=>{
      if(!touchStart) return; const t=e.changedTouches[0];
      const dx=t.clientX - touchStart.x; const dy=t.clientY - touchStart.y;
      const ax=Math.abs(dx), ay=Math.abs(dy), thr=24;
      if(Math.max(ax,ay)<thr) return; // ignore tiny moves
      if(ax>ay) step(dx>0?'right':'left'); else step(dy>0?'down':'up');
      touchStart=null;
    });

    // Buttons
    $('#newBtn').addEventListener('click', reset);
    $('#againBtn').addEventListener('click', reset);
    $('#undoBtn').addEventListener('click', undo);
    $('#sizeSelect').addEventListener('change', reset);
    $('#themeBtn').addEventListener('click', ()=>{
      document.body.classList.toggle('light');
      localStorage.setItem('theme_2048', document.body.classList.contains('light')?'light':'dark');
    });

    // Init
    (function init(){
      const theme = localStorage.getItem('theme_2048');
      if(theme==='light') document.body.classList.add('light');
      if(!restoreState()) { reset(); }
    })();
  </script>
</body>
</html>
